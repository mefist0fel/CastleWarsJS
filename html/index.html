<html>
	<head>
		<title>Elements prot</title>
		<style type="text/css">
		body {
			display: block;
			background-color:0;
			width: 100%;
			height: 100%;
			margin: 0;
		}
		canvas {
			background-color:#ffffff;
			display: block;
			margin: 0px auto;
		}
		</style>
	</head>
	<body>
		<canvas id="a"></canvas>
	</body>
	<script type="text/javascript" src="geometry.js"></script>
	<script type="text/javascript" src="input.js"></script>
	<script type="text/javascript" src="jsfxr.js"></script>
	<script type="text/javascript" src="audio.js"></script>
	<script type="text/javascript" src="castle.js"></script>
	<!--
	<script type="text/javascript" src="camera.js"></script>
	<script type="text/javascript" src="map.js"></script>
	<script type="text/javascript" src="hero.js"></script>-->
	<script type="text/javascript">
	
	const reloadTime = 1.0;
	const playerFaction = 0;
	var now,
		dt = 0,
		time = timestamp(),
		reloadTimer = reloadTime,
		step = 1/30,
		width = 1024,
		height = 768;

	// init
	var canvasElement = document.getElementById('a');
	var canvas = canvasElement.getContext('2d');
	canvasElement.width = width;
	canvasElement.height = height;
	rect = canvasElement.getBoundingClientRect();
	var selectedCastle = null;
	var isClickStarted = true;

	var castles = [];
	castles[0] = Castle(300, 300, 0);
	castles[1] = Castle(300, 500);
	castles[2] = Castle(700, 500, 1);
	castles[3] = Castle(700, 300);
	console.log(castles);


	var input = Input(rect);
	//var camera = Camera();
	//var player = Hero();
	// setMoveDirection(45);

	function timestamp() {
		let perf = window.performance;
		return perf && perf.now ? perf.now() : new Date().getTime();
	}

	function render(dt) {
		// clear
		canvas.fillStyle    = '#101010';  // black
		canvas.fillRect ( 0, 0, width, height);
		// test
		// canvas.fillStyle    = '#FFFFFF';  // white
		// canvas.fillRect (10, 10, 100, 100)

		// Selected castle
		if (selectedCastle != null) {
			selectedCastle.drawSelection(canvas);
		}

		// castles
		for(var i = 0; i < castles.length; i++) {
			castles[i].draw(canvas)
		 	// drawCastle(castles[i], canvas);
		}

		// help
		canvas.font = "14pt Arial";
		//canvas.fillText("Q / E - Rotate level", 10, 30)
		//canvas.fillText("Z / X - change height constant", 10, 50)
		// canvas.fillText("C / V - c//hange tile aspect", 10, 50)
		// canvas.fillText("dt " + dt, 10, 30)
	}

	function update(dt) {
		reloadTimer -= dt;
		if (reloadTimer <= 0) {
			reloadTimer = reloadTime;
			for(var i = 0; i < castles.length; i++) {
				castles[i].apply()
			}
		}
		if (input.mouseLeft) {
			if (!isClickStarted) {
				isClickStarted = true;
				selectedCastle = getCastle(input.mousePosition);
			}
		} else {
			if (isClickStarted) {
				isClickStarted = false;
				// selectedCastle = getCastle(input.mousePosition);
			}
		}
	}

	function getCastle(pos) {
		for(var i = 0; i < castles.length; i++) {
			if (castles[i].contains(pos)) {
				return castles[i];
			}
		}
		return null;
	}
	
	function frame() {
		now = timestamp();
		dt = Math.min(1, (now - time) / 1000);
		if (dt > step) {
			dt = step;
		}
		time = now;
		update(dt);
		render(dt);
		requestAnimationFrame(frame);
	}
	requestAnimationFrame(frame);
	</script>
</html>